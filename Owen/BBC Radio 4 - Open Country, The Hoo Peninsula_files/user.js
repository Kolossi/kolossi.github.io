define(["./web-storage/cookie-storage","./util/event-provider","./util/env","require","exports"],function(n,e,t,i,r){function o(n){n=n&&n.toLowerCase()||"en-gb";var e={en:"en-GB",cy:"cy-GB",ga:"ga-GB",gd:"gd-GB","en-gb":"en-GB","cy-gb":"cy-GB","ga-gb":"ga-GB","gd-gb":"gd-GB"};return e[n]||"en-GB"}function c(n,e){var t,i;return e=e||{},t=e.ptrt||window.location.href,i="pal.sandbox.dev.bbc.co.uk"==window.location.hostname?"https://www.test.bbc.co.uk":"",i+"/id/"+o(e.locale)+"/"+n+"?ptrt="+encodeURIComponent(t)}function a(n,e){"signedIn"==n&&s[n]&&s.signinCancelled&&(s.signinCancelled(new r.SigninCancelledError),s={}),s[n]=e}r.events=new e,r.getUser=function(){var e,i=n.get("IDENTITY"),o=n.get("IDENTITY_ENV"),c=t.getEnv(),a=!1;if(i){if(o&&c&&"sandbox.dev"!==c&&o!==c)return!1;if(r._cached&&r._cachedObject&&r._cached==i)return r._cachedObject;e=window.decodeURIComponent(i),e=e.split("|"),e&&e.length>=5&&(r._cached=i,r._cachedObject=a={id:e[0],username:e[1],displayName:window.decodeURIComponent(e[2]).replace(/\+/g," ")})}return a},r.getUserProperty=function(n){var e=r.getUser();return e?e[n]:!1},r.getDisplayName=function(){return r.getUserProperty("displayName")},r.getUserId=function(){return r.getUserProperty("id")},r.getUsername=function(){return r.getUserProperty("username")},r.isSignedIn=function(){return!!r.getUser()},r.getSignInUrl=function(n){var e;return n=n||{},"undefined"!=typeof n.item&&(e=n.ptrt||window.location.href,n.ptrt=window.location.protocol+"//"+window.location.hostname+"/modules/personalisation/my/favourites/signedin.html?params[ptrt]="+e+"&params[item]="+n.item),c("signin",n)},r.getSignOutUrl=function(n){return c("signout",n)},r.getRegisterUrl=function(n){return c("register",n)},r.doFullPageSignIn=function(n){var e=r.getSignInUrl(n);n.target&&"_self"!=n.target?window.open(e,n.target):window.location.href=e};var s={};return r.onSignedIn=function(){s.signedIn&&(s.signedIn(),s={})},r.events.subscribe("signedIn",r.onSignedIn),r.onSigninCancelled=function(){s.signinCancelled&&(s.signinCancelled(new r.SigninCancelledError),s={})},r.events.subscribe("signinCancelled",r.onSigninCancelled),r.signIn=function(n,e){"function"==typeof n&&(e=n,n={}),n=n||{},n.useOverlay=n.useOverlay!==!1,n.target=n.target||"_self",n.locale=o(n.locale),e=e||n.onSuccess;{var t=n.onError||e;({useOverlay:n.useOverlay,locale:n.locale,policyname:n.policyname,ptrt:n.ptrt})}if(!n.useOverlay)return r.doFullPageSignIn(n);var c=setTimeout(function(){r.doFullPageSignIn(n)},7e3);i(["idcta/idcta-1"],function(){clearTimeout(c),a("signedIn",e),a("signinCancelled",t)})},r._listenToIdEvents=function(){i(["idcta/idcta-1"],function(n){if(n&&"object"==typeof n.signals){var e=function(e){var t=n.signals[e];return t&&"function"==typeof t.add?(t.add(function(){r.events.publish(e)}),!0):!1};e("signedIn")&&e("signinShown"),r.events.subscribe("signinShown",function(){r._cancelEventSet||(i(["jquery-1.9"],function(n){n("#bbcid-mask, #bbcid-overlay-container .close-button a").click(function(){r.events.publish("signinCancelled")}),n(document).keyup(function(n){27==n.keyCode&&r.events.publish("signinCancelled")})}),r._cancelEventSet=!0)})}})},r.SigninCancelledError=function(){this.name="ps_SigninCancelled",this.eventDescriptor="signInCancelled",this.message="User must sign in for this functionality"},r.SigninCancelledError.prototype=new Error,r._listenToIdEvents(),r});
//# sourceMappingURL=user.js.map