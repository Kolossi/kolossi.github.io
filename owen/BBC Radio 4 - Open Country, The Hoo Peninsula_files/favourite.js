define("personalisation/settings/app",{sos2012:{favourite:{allowAnonymous:!0,limit:5}},demo:{favourite:{allowAnonymous:!0,limit:3}}}),define("personalisation/settings",["./settings/app","exports"],function(e,t){var n=function(e,t,n){this._name=e,this._options={},this._parent=n;for(var r in t)this.set(r,t[r])};return n.prototype={apply:function(e){for(var t in e){var r=e[t];"object"==typeof r&&this._options[t]instanceof n?this._options[t].apply(r):this.set(t,r)}},set:function(e,t){"object"==typeof t&&(t=new n(e,t,this),this[e]=t),this._options[e]=t},_getAppSettings:function(e){if(e){if(this.app&&this.app[e])return this.app[e];if(this._parent&&(appSettings=this._parent._getAppSettings(e)))return appSettings[this._name]}},get:function(e,t,n){return n=this._getAppSettings(t),n?n.get(e):this._options[e]?this._options[e]:void 0},_class:n},n.defaults={throwExceptions:!0,debug:!1,app:{},favourite:{allowAnonymous:!1,limit:1e4,anonExpiry:604800}},t=new n("personalisation",n.defaults),window._personalisation&&t.apply(window._personalisation),e&&t.app.apply(e),t}),define("personalisation/util/env",["exports","module"],function(e,t){var n="/modules/personalisation/",r=new RegExp("^https?://(cdn-www|www|pal|ssl)\\.((sandbox\\.dev|int|test|stage|live)\\.)?bbc\\.co\\.uk/.*$"),i=new RegExp("https?://static\\.((sandbox\\.dev|int|test|stage|live)\\.)?bbci?\\.co\\.uk/.+");return e._getModule=function(){return t},e.getLocation=function(){return window.location},e.getEnv=function(){var t,n=e.getLocation().href;return r.test(n)?(t=r.exec(n),t&&t[3]||"live"):void 0},e.getStaticEnv=function(){var t,n=e._getModule(),r=n&&n.uri||"";return i.test(r)?(t=i.exec(r),t&&t[2]||"live"):void 0},e.getPALHost=function(t,n){t=t||e.getEnv(),n=n||window.location.protocol;var r,i="https:"==n;return"sandbox.dev"==t?r=(i?"ssl":"pal")+".sandbox.dev":(r=i?"ssl":"www",t=t||"live","live"!==t&&(r+="."+t)),r+".bbc.co.uk"},e.getStaticHost=function(t){return t=e.getEnv(),["static",t.length>0?".":"",t,".bbc.co.uk"].join("")},e.resolveURL=function(t,r){if("string"!=typeof t)return void 0;r=r||e.getPALHost();var i="/"==t.charAt(0)?"":n;return[window.location.protocol,"//",r,i,t].join("")},e.resolveStaticURL=function(t){return e.resolveURL(t,e.getStaticHost())},e}),define("personalisation/util",["jquery-1.9","./util/env","exports","module"],function(e,t,n){new RegExp("https?://static\\.(.+?)?\\.?bbc\\.co\\.uk/.+");return n={apply:function(e,t,n){for(n in t)e[n]=t[n];return e},env:t,getPALHost:t.getPALHost,getStaticHost:t.getStaticHost,resolveURL:t.resolveURL,resolveStaticURL:t.resolveStaticURL,getCookie:function(e){for(var t=[e,"="].join(""),n=document.cookie.split(";"),r=0;r<n.length;r++){for(var i=n[r];" "==i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null},setCookie:function(e,t,n,r,i){return r=r||"/",i=i||".bbc.co.uk",!!(document.cookie=e+"="+t+(n?";expires="+n.toGMTString():"")+";path="+r+";domain="+i)},deleteCookie:function(e,t,r){return n.setCookie(e,"",new Date(-1),t,r)},quoteString:function(e,t){return e=/["\\\x00-\x1f\x7f-\x9f]/g,t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},function(n){return n.match(e)?'"'+n.replace(e,function(e){var n=t[e];return"string"==typeof n?n:(n=e.charCodeAt(),"\\u00"+Math.floor(n/16).toString(16)+(n%16).toString(16))})+'"':'"'+n+'"'}}(),json:{parse:function(t){return window.JSON&&window.JSON.parse?JSON.parse(t):e.parseJSON(t)},_stringify:function(e,t,r,i,o,s){if(t=typeof e,"undefined"==t||"number"==t||"boolean"==t)return String(e);if("string"==t)return n.quoteString(e);if(e.toJSON&&"function"==typeof e.toJSON)return n.json.stringify(e.toJSON());if(r="",s=[],e instanceof Array){for(i=0;o=e[i];i++)s.push(n.json.stringify(o)||"null");return"["+s.join(",")+"]"}for(i in e){if(o=e[i],t=typeof i,"number"===t)i='"'+i+'"';else{if("string"!==t)continue;i=n.quoteString(i)}t=typeof o,"function"!==t&&"undefined"!==t&&(o=n.json.stringify(o),s.push(i+":"+o))}return"{"+s.join(",")+"}"},stringify:function(e,t){return t=window.JSON,t&&t.stringify?t.stringify(e):n.json._stringify(e)}}},n.ArrayIterator=function(e,t){this.array=e.slice(0),this.length=this.array.length||0,this.idx=t?this.length:-1},n.ArrayIterator.prototype={hasNext:function(){return this.idx<this.length-1},hasPrevious:function(){return this.idx>0},next:function(){return this.idx++,this.array[this.idx]},previous:function(){return this.idx--,this.array[this.idx]}},n.callWrapper=function(e,t,n,r,i,o){if(r=r||[],i=i||this,void 0===o&&(o=!0),t)return r.push(n),e.apply(i,r);try{returnValue=e.apply(i,r)}catch(s){if(o)throw s;returnValue=s}return n(returnValue)},n}),define("personalisation/util/event-provider",["../util","exports"],function(e,t){var n=".";return t=function(){this._events={}},t.prototype={publish:function(e,t,r,i,o){if(r=!1,e instanceof Array)for(o=0;i=e[o];o++)i=i.split(n),r=this._publishHierarchy(e,i.pop(),i,t)||r;else i=e.split(n),r=this._publishHierarchy(e,i.pop(),i,t);return this._publishActual(e,"all",t)||r},_publishActual:function(e,t,n,r,i,o,s,a,c){if(r=r||this._events,c=!1,r[t])for(i=r[t]._listeners,s=0;o=i[s];s++){if(a=o.context||this,o=o.callback||o,o.call(a,n,e)===!1)return!0;c=!0}return c},_publishHierarchy:function(e,t,n,r,i,o,s,a,c){return i=i||0,o=o||this._events,s=n[i],c=!1,s&&o[s]&&(a=o[s],c=this._publishHierarchy(e,t,n,r,i+1,a),c=this._publishActual(e,n[i],r,o)||c),this._publishActual(e,t,r,o)||c},subscribe:function(e,t,r,i,o,s){if("string"==typeof e&&"function"==typeof t){for(i=this._events,o=e.split(n),s=0;e=o[s];s++)i[e]=i[e]||{_listeners:[]},i=i[e];return i._listeners.push(void 0===r?t:{callback:t,context:r}),!0}return!1},toString:function(){return"EventProvider"}},t}),define("personalisation/favourite/event",["jquery-1.9","../util/event-provider","exports"],function(e,t,n){return n=new t}),define("personalisation/model/item",["../util","exports"],function(e,t){function n(e,n){var r=e[n];if(!r||"string"!=typeof r)throw new t.ItemSyntaxError(e,n,r);return!0}t=function(e,t){var n,i;e=r(e,t);for(n in e)this[n]=this[n]||e[n];this["class"]=this["class"]||"bbc",this.title=this.title||this.id,i=isNaN(this.postedTime)?new Date:new Date(this.postedTime),this.postedTime=i.getTime()},t.prototype={equals:function(e){return e&&this.id===e.id&&this.type===e.type&&this.appId===e.appId},toJSON:function(){return{type:this.type,id:this.id,appId:this.appId,title:this.title,postedTime:this.postedTime}},toJSONString:function(){return e.json.stringify(this)},toURN:function(){var e="urn:"+this["class"]+":"+encodeURIComponent(this.appId)+":"+encodeURIComponent(this.type)+":"+encodeURIComponent(this.id);return this.title&&this.title!==this.id&&(e+=":title="+encodeURIComponent(this.title)),e},toString:function(){return"Item["+this.appId+"/@"+this.type+"/"+this.id+"]"},update:function(e){return e=e||new Date,e instanceof Date&&(e=e.getTime()),isNaN(e)&&e>this.postedTime?(this.postedTime=e,!0):!1}},t.ItemSyntaxError=function(e,t,n){this.name="Personalisation_ItemSyntaxError",this.given=e,this.message="Missing required property for an Item.",t&&(this.message='Invalid item property value for "'+t+'", given: '+n)},t.ItemSyntaxError.prototype=new Error;var r=function(e,o){var s=typeof e;if("object"===s)return!e.appId&&e.appid&&(e.appId=e.appid,delete e.appid),e.appId||(e.appId=o),n(e,"appId")&&n(e,"type")&&n(e,"id"),e;if("string"===s){r._regex||(r._regex=/^urn:([^:]+):([^:]+):([^:]+):([^:]+)(?::title=([^:]+))?/);var a=i(e,r._regex);if(a||(r._legacyRegex||(r._legacyRegex=/^(?:(\w+):\/\/)?(?:\/([\w\.%+-]+)\/)?@?([\w\.%+-]+)\/([\w\.%+-]+)(?:\?title=([\w\.%+-]+))?/),a=i(e,r._legacyRegex)),a)return a}throw new t.ItemSyntaxError(e)},i=function(e,t){var n={},i=t.exec(e);return i?(n["class"]=decodeURIComponent(i[1]),"bbc"==n["class"]&&(i[2]&&(n.appId=decodeURIComponent(i[2])),i[3]&&(n.type=decodeURIComponent(i[3])),i[4]&&(n.id=decodeURIComponent(i[4])),i[5]&&(n.title=decodeURIComponent(i[5]))),r(n)):!1};return t}),define("personalisation/model/map",["../util","./item","exports"],function(e,t,n){return n=function(e){this.entry=[],this.types={},this.length=0,this.max=void 0,e&&this.addAll(e,!0,!0)},n.prototype={add:function(e,r){var i=this.find(e);if(i)return r!==!1&&e.postedTime>i.postedTime?this.replace(i,e):!1;if(!this.canAdd(e))throw new n.LimitReachedError(this);return e instanceof t||(e=new t(e)),this._insertEntry(e)},addAll:function(t,n,r){if("string"==typeof t&&(t=e.json.parse(t)),t instanceof Array){var o,s=[];for(i=0;o=t[i];i++)if(r)try{o=this.add(o,n),o&&s.push(o)}catch(a){var c=window.console;c&&"function"==typeof c.warn&&c.warn("Personalisation error: "+a)}else o=this.add(o,n),o&&s.push(o);return s}return"object"==typeof t?t.entry?this.addAll(t.entry,n,r):this.add(t,n):!1},canAdd:function(){return!this.isFull()},contains:function(){return!!this.find.apply(this,arguments)},each:function(e,t,n){if("function"==typeof e){var r,i,o=n?this.length-1:0,s=n?-1:1;for(t=t||this;i=this.entry[o];o+=s)if(r=e.call(t,i,o,this.entry),void 0!==r)return r}},eachInReverse:function(e,t){return this.each(e,t,!0)},equals:function(t){if(t===this)return!0;if("string"==typeof t)return this.equals(e.json.parse(t));var n=t.length||t.totalResults;return t.entry instanceof Array&&(void 0===n||n==this.length)?void 0===this.each(function(e,n){return e.equals(t.entry[n])?void 0:!1}):!1},find:function(e,t){return"object"==typeof e&&e.id&&e.type&&(t=e.type,e=e.id),t=this.types[t],t&&t[e]},filter:function(e,t){var n=this.entry,r=n.slice(0);t=t||this;for(var i=n.length-1;i>=0;i--)e.call(t,n[i],i,n)||r.splice(i,1);return r},getIndex:function(e){return this.entry[e]},getItemsWithType:function(e){var t=this.types[e];return t||(t=this.types[e]={}),t},isEmpty:function(){return!this.length},isFull:function(){return!isNaN(this.max)&&this.length>=this.max},remove:function(e){if(!(e instanceof t||(e=this.find(e))))return!1;var n=this._indexOf(e);return-1===n?!1:this._removeIndex(n,e)},replace:function(e,t){return this.remove(e)&&this.add(t)},toJSON:function(){return{entry:this.entry}},toJSONString:function(){return e.json.stringify(this)},toString:function(){return"Map"},_indexOf:function(e){for(var t,n=0;t=this.entry[n];n++)if(t===e||t.equals(e))return n;return-1},_insertEntry:function(e){this.getItemsWithType(e.type)[e.id]=e;for(var t=this.length;t--;)if(e.postedTime>=this.entry[t].postedTime)return this.entry.splice(t+1,0,e),this.length++,e;return this.entry.unshift(e),this.length++,e},_removeIndex:function(e,t){return t=t||this.entry[e],t&&(this.entry.splice(e,1),delete this.types[t.type][t.id],this.length--),t}},n.prototype.get=n.prototype.find,n.LimitReachedError=function(e){this.name="LimitReached",this.eventDescriptor="limited",this.map=e,this.max=e.max,this.message="Maximium number of items reached"},n.LimitReachedError.prototype=new Error,n}),define("personalisation/model/item-map",["../util","./item","./map","exports"],function(e,t,n,r){return r=function(){this.apps={},n.apply(this,arguments)},r.prototype=new n,r.prototype.constructor=r,e.apply(r.prototype,{canAdd:function(e){var t,r=!0;return e&&e.appId&&(t=this.getItemsWithAppId(e.appId),r=n.prototype.canAdd.apply(t,arguments)),r&&n.prototype.canAdd.apply(this,arguments)},find:function(e,t,r){return r=r||"object"==typeof e&&e.appId,r?(r=this.apps[r],r&&r.find(e,t)||void 0):n.prototype.find.apply(this,arguments)},getItemsWithAppId:function(e){var t=this.apps[e];return t||(t=this.apps[e]=new n),t},_insertEntry:function(e){return n.prototype._insertEntry.apply(this,arguments)&&n.prototype._insertEntry.apply(this.getItemsWithAppId(e.appId),arguments)},_removeIndex:function(e,t){return t=n.prototype._removeIndex.apply(this,arguments),t&&this.getItemsWithAppId(t.appId).remove(t)},toString:function(){return"ItemMap"}}),r.LimitReachedError=n.LimitReachedError,r}),define("personalisation/favourite/error",["exports"],function(e){return e=e||{},e.LimitReached=function(e){this.name="LimitReached",this.eventDescriptor="limited",this.max=e,this.message="Maximium number of favourites reached - "+e},e.LimitReached.prototype=new Error,e.ServiceError=function(e,t){this.name="ServiceError",this.eventDescriptor="service",this.xhr=e,this.status=e&&e.status,this.message=this.status+" "+t},e.ServiceError.prototype=new Error,e.NoUser=function(){this.name="NoUser",this.message="User not signed in"},e.NoUser.prototype=new Error,e}),define("personalisation/favourite/model/map",["../../model/map","../../model/item-map","../../settings","../error","exports"],function(e,t,n,r,i){var o={radio:{music_guide:12}};return i=function(){t.apply(this,arguments)},i.prototype=new t,i.constructor=i,i.prototype.getItemsWithAppId=function(e){var r=t.prototype.getItemsWithAppId.apply(this,arguments);return r.max||(r.max=n.favourite.get("limit",e)),r},i.prototype.canAdd=function(e){var n,r=e.appId,i=e.type,s=o[r]&&o[r][i];return s&&(n=this.filter(function(e){return e.appId==r&&e.type==i}),n.length===s)?!1:t.prototype.canAdd.apply(this,arguments)},i.prototype.toString=function(){return"FavouriteMap"},i.LimitReachedError=t.LimitReachedError,i}),define("personalisation/web-storage/cookie-storage",["../util","exports"],function(e,t,n){return n=window.bbccookies||{get:function(){return document.cookie},set:function(e){return document.cookie=e}},t={get:function(e){return t.getCookies()[e]},getCookies:function(e,r,i,o,s,a){if(e=n.get(),t._cached&&t._cachedMap&&t._cached==e)return t._cachedMap;r={};try{if(e&&e.split)for(i=e.split(";"),o=0;a=i[o];o++){for(;" "==a.charAt(0);)a=a.substring(1,a.length);s=a.indexOf("="),r[a.substring(0,s)]=a.substring(s+1)}}catch(c){return r}return t._cached=e,t._cachedMap=r,r},isAvailable:function(e,t,r){if(t=n.get(),r=!1,t)r=!0;else try{r="function"==typeof n.cookiesEnabled&&n.cookiesEnabled()}catch(i){r=!1}return r&&(e?n.isAllowed(e):!0)},set:function(e,t,r,i,o){return i=i||"/",o=o||".bbc.co.uk",!!n.set(e+"="+t+(r instanceof Date?";expires="+r.toGMTString():"")+";path="+i+";domain="+o)},remove:function(e,n,r){try{return t.set(e,"",new Date(-1),n,r)}catch(i){}return!1},clear:function(){},clearPrefix:function(e,n,r,i,o){o=t.getCookies();for(i in o)0===i.indexOf(e)&&t.remove(i,n,r)}}}),define("personalisation/web-storage/dom-storage",["require"],function(e){return e=function(e){this.storageKey=e;try{this.storage=window[e],this.storage.length}catch(t){this.storage=!1}},e.prototype={get:function(e){try{return this.storage&&this.storage.getItem?this.storage.getItem(e):void 0}catch(t){return void 0}},isAvailable:function(e,t,n,r){if(void 0===this._available){if(r=!1,e=this.storage,e&&e.getItem&&e.setItem&&e.removeItem){t="ps_sTest",n="ps_sTestValue";try{e.removeItem(t),e.setItem(t,n),r=e.getItem(t)==n,e.removeItem(t)}catch(i){r=!1}}this._available=r}return this._available},set:function(e,t){if(this.storage&&this.storage.setItem)try{return this.storage.setItem(e,t)}catch(n){try{return this.remove(e),this.storage.setItem(e,t)}catch(r){throw n}}return!1},remove:function(e,t){try{if(t=this.storage,t&&t.removeItem)return t.removeItem(e)}catch(n){}return!1},clear:function(e){try{return e=this.storage,e&&e.clear&&e.clear()}catch(t){return!1}},clearPrefix:function(e,t,n,r){try{if(t=this.storage,t&&t.key){for(r=0;r<t.length;r++)n=t.key(r),0==n.indexOf(e)&&this.remove(n);return!0}}catch(i){}return!1}},e.LocalStorage=new e("localStorage"),e.SessionStorage=new e("sessionStorage"),e}),define("personalisation/web-storage/js-storage",["require"],function(e){return e={_values:{},get:function(t){return e._values[t]},isAvailable:function(){return!0},set:function(t,n){return!!(e._values[t]=n)},remove:function(t){return delete e._values[t]},clear:function(){return delete e._values,e._values={},!0},clearPrefix:function(t,n){for(n in e._values)0==n.indexOf(t)&&e.remove(n)}}}),define("personalisation/web-storage",["./settings","./web-storage/cookie-storage","./web-storage/dom-storage","./web-storage/js-storage","exports"],function(e,t,n,r,i,o,s,a,c){return o=n.LocalStorage,s=n.SessionStorage,a="_",c="ck",i=function(e){this.namespace=e,this.isAllowed()},i.prototype={jsStoreEnabled:!1,get:function(e){return e=this.namespace+a+e,this.jsStoreEnabled&&r.get(e)||s.get(e)||o.get(e)||t.get(c+e)},set:function(e,n,r,o,s){if(r&&(o=o||new Date((new Date).getTime()+1e3*r)),s=this._getStorage(!!o),e=this.namespace+a+e,cookieKey=c+e,null===s)throw new i.StorageNotAllowedError(cookieKey);if(s===!1)throw new i.NoStorageAvailableError;return this._remove(e,cookieKey),s===t&&(e=cookieKey),s.set(e,n,o)},isAllowed:function(e,n){return e=c+this.namespace+a+"my",n=window.bbccookies,!n||"function"!=typeof n.isAllowed||n.isAllowed(e)&&t.isAvailable()?!0:(this.clear(),!1)},isAvailable:function(){return!!this._getStorage()},_getStorage:function(n,i){return i=null,this.isAllowed()&&(n&&o.isAvailable()?i=o:(i=s,i.isAvailable()||(i=!1)),(e.get("forceCookies")||!i)&&(i=t.isAvailable()?t:!1)),!i&&this.jsStoreEnabled&&(i=r),i},remove:function(e){e=this.namespace+a+e,this._remove(e,c+e)},_remove:function(e,n){o.remove(e),s.remove(e),t.remove(n),this.jsStoreEnabled&&r.remove(e)},clear:function(e){e=this.namespace,o.clearPrefix(e),s.clearPrefix(e),t.clearPrefix(c+e),this.jsStoreEnabled&&r.clearPrefix(e)}},i._instances={},i.getInstance=function(e,t){return t=i._instances[e]=i._instances[e]||new i(e)},i.NoStorageAvailableError=function(){this.name="PCL_NoStorageAvailableError",this.message="Cookies and DOMStorage are unavailable for web storage"},i.NoStorageAvailableError.prototype=new Error,i.StorageNotAllowedError=function(e){this.name="PCL_StorageNotAllowedError",this.cookieKey=e,this.policy=i._cookieJars[e.substring(0,4)]||"unknown",this.message="Web storage is not allowed for "+this.policy+" items"},i.StorageNotAllowedError.prototype=new Error,i._cookieJars={ckad:"ads",ckps:"personalisation",ckpf:"performance",ckns:"necessary"},i}),define("personalisation/favourite/model/anonymous",["./map","../../model/map","../../model/item","../../settings","../../web-storage","../event","../error","exports"],function(e,t,n,r,i,o,s,a){var c="ps_my",u="f";return a={_map:void 0,_storage:i.getInstance(c),isAvailable:function(){return a._storage.isAvailable()},hasFavourites:function(){return!a.get().isEmpty()},get:function(t){if(!a._map)try{var n=a._storage.get(u);a._map=new e(n),o.publish(["anon.retrieved","anon.get.success"],{items:a._map})}catch(r){if(o.publish("anon.get.failed",{error:r}),!t)throw r;return t(r)}return t&&t(a._map),a._map},add:function(t,n,r,i,s){r=a.get(),i={item:t};try{return t=r.add(t),a._storeItems(r),o.publish(["anon.added","anon.add.success","anon.changed"],i),n&&n(t)||t}catch(c){if(i.error=c,s="anon.add.failed",c instanceof e.LimitReachedError?s="anon.add.failed.limited":r.remove(t),o.publish(s,i),!n)throw c;return n(c)}},clear:function(){try{a._storage.remove(u),a._map=void 0,o.publish("anon.clear.success")}catch(e){if(o.publish("anon.clear.failed",{error:e}),!callback)throw e;callback(e)}},isFirstTimeUser:function(){return!a._storage.get(u)},migrate:function(e,n){var r,i=new t,o=[],s={};n=n||a.get(),n.eachInReverse(function(t){if(r=a._replaceIfNewer(e,t),r&&"object"==typeof r)o.push(r);else if(r===!1)return!1;null!==r&&i.add(t)});for(var c,u=0;c=o[u];)i.contains(c)?(i.remove(c),o.splice(u,1)):u++;return a.clear(),i.isEmpty()||(s.create=i.entry),o.length&&(s["delete"]=o),s},_replaceIfNewer:function(e,t){var r=e.find(t);if(r)return t.postedTime>r.postedTime?e.replace(r,t)&&null:!1;if(t instanceof n||(t=new n(t)),!e.canAdd(t)){var i=e.getItemsWithAppId(t.appId).entry[0];return i&&t.postedTime>=i.postedTime?(i=e.remove(i),e._insertEntry(t)&&i):!1}return!!e._insertEntry(t)},remove:function(e,t){var n=a.get();try{if(e=n.remove(e))return a._storeItems(n),o.publish(["anon.removed","anon.remove.success","anon.changed"],{item:e}),t&&t(e),e}catch(r){if(o.publish("anon.remove.failed",{item:e,error:r}),n.add(e),!t)throw r;return t(r)}},replace:function(e,t,n,r,i,s){r=a.get(),i={"old-item":e,item:t};try{return s=r.replace(e,t),s?(a._storeItems(r),o.publish(["anon.replaced","anon.replace.success","anon.changed"],i)):o.publish("anon.replace.failed",i),n&&n(s),s}catch(c){if(i.error=c,o.publish("anon.replace.failed",i),s!==!1&&r.remove(s),r.add(e),!n)throw c;return n(c)}},_storeItems:function(e){return a._storage.set(u,e.toJSONString(),r.favourite.get("anonExpiry"))}}});var _personalisationDisableSSL;define("personalisation/favourite/model/snes-service",["jquery-1.9","../../util","exports"],function(e,t,n){var r=function(e){var n,r="/modules/personalisation/my/favourites";return _personalisationDisableSSL!==!0&&(n=t.getPALHost(!1,"https:"),r="https://"+n+r,i(e,n)&&(r+=".relay")),"delete"==e&&(r+="?_method=delete"),r},i=function(e,t){return!("post"!=e&&"delete"!=e||"https:"===n._getProtocol()&&n._getHost()===t)},o={get:{type:"GET",dataType:"jsonp",contentType:"application/json"},post:{type:"POST",dataType:"json",contentType:"application/json"},"delete":{type:"POST",dataType:"json",contentType:"application/json"},batch:{url:"/modules/personalisation/my/favourites/batch",type:"POST",contentType:"application/json",dataType:"json"}};return n={request:function(e,i){if("string"!=typeof i.data&&(i.data=t.json.stringify(i.data)),!o[e])throw"Unknown SNeS method: "+e;i.url=r(e);for(var s in o[e])i[s]||(i[s]=o[e][s]);return n._makeRequest(i)},_getHost:function(){return window.location.host},_getProtocol:function(){return window.location.protocol},_makeRequest:function(t){return window.console&&t.async===!1&&window.console.warn("PCL: Favourites should not be called synchronously"),-1!==t.url.indexOf(".relay")?n._relay(t):e.ajax(t)},_relay:function(e){require(["relay-1"],function(n){return n.post(e.data,e.url,function(n){if(null===n){var r="Relay timed out retrieving: "+e.url;e.error&&e.error(void 0,r,new Error(r))}else"string"==typeof n&&(n=t.json.parse(n)),e.success&&e.success(n)})})}}}),define("personalisation/web-storage/cache",["../settings","../util","../web-storage","../util/event-provider","exports"],function(e,t,n,r,i,o,s){return o="_c",s=120,i=function(e){this.namespace=e+o,this.storage=n.getInstance(this.namespace),this.storage.jsStoreEnabled=!0,this._locks={},this._callbacks={}},i.prototype={get:function(e,t,n,r,o,a,c,u){if(o=this.storage.get(e),"function"==typeof n&&(r=n,n=s),n=n||s,o&&(o=i.CachedObject.unserialise(o),a=o.value),c={namespace:this.namespace,key:e,canUpdate:!!t,interval:n,async:!!r,value:a},"function"!=typeof t||o&&!o.needsUpdate(n))o?i.events.publish("cache.hit",c):a=!1;else{if(i.events.publish("cache."+(o?"update":"miss"),c),r)return void(this._callbacks[e]?this._callbacks[e].push(r):(this._callbacks[e]=[r],t(a,o&&o.lastUpdated)));try{u=t(a,o&&o.lastUpdated)}catch(l){u=l}u&&(this.update(e,u),a=u)}return r&&r(a),a},update:function(e,t,n,r,o,a,c){if(a={namespace:this.namespace,key:e,value:t,cacheValue:n},t instanceof Error?(a.error=t,c="cache.update.failed"):(n=a.cacheValue=new i.CachedObject(t),c="cache.updated",this.storage.set(e,n.toJSONString(),s)),i.events.publish(c,a),this._callbacks[e]){for(o=0;r=this._callbacks[e][o];o++)r(t);this._callbacks[e]=!1}return t},remove:function(e){this.storage.remove(e)},clear:function(){this.storage.clear()}},i._instances={},i.events=new r,i.CachedObject=function(e,t){this.value=e,this.lastUpdated=t||(new Date).getTime()},i.CachedObject.prototype={needsUpdate:function(e){return this.lastUpdated+1e3*e<=(new Date).getTime()},toJSON:function(){return{value:this.value,lastUpdated:this.lastUpdated}},toJSONString:function(){return t.json.stringify(this)}},i.CachedObject.unserialise=function(e){return"string"==typeof e&&(e=t.json.parse(e)),new i.CachedObject(e.value,e.lastUpdated)},i.getInstance=function(e,t){return t=i._instances[e]=i._instances[e]||new i(e)},i}),define("personalisation/user",["./web-storage/cookie-storage","./util/event-provider","./util/env","require","exports"],function(e,t,n,r,i){function o(e){e=e&&e.toLowerCase()||"en-gb";var t={en:"en-GB",cy:"cy-GB",ga:"ga-GB",gd:"gd-GB","en-gb":"en-GB","cy-gb":"cy-GB","ga-gb":"ga-GB","gd-gb":"gd-GB"};return t[e]||"en-GB"}function s(e,t){var n,r;return t=t||{},n=t.ptrt||window.location.href,r="pal.sandbox.dev.bbc.co.uk"==window.location.hostname?"https://www.test.bbc.co.uk":"",r+"/id/"+o(t.locale)+"/"+e+"?ptrt="+encodeURIComponent(n)}function a(e,t){"signedIn"==e&&c[e]&&c.signinCancelled&&(c.signinCancelled(new i.SigninCancelledError),c={}),c[e]=t}i.events=new t,i.getUser=function(){var t,r=e.get("IDENTITY"),o=e.get("IDENTITY_ENV"),s=n.getEnv(),a=!1;if(r){if(o&&s&&"sandbox.dev"!==s&&o!==s)return!1;if(i._cached&&i._cachedObject&&i._cached==r)return i._cachedObject;t=window.decodeURIComponent(r),t=t.split("|"),t&&t.length>=5&&(i._cached=r,i._cachedObject=a={id:t[0],username:t[1],displayName:window.decodeURIComponent(t[2]).replace(/\+/g," ")})}return a},i.getUserProperty=function(e){var t=i.getUser();return t?t[e]:!1},i.getDisplayName=function(){return i.getUserProperty("displayName")},i.getUserId=function(){return i.getUserProperty("id")},i.getUsername=function(){return i.getUserProperty("username")},i.isSignedIn=function(){return!!i.getUser()},i.getSignInUrl=function(e){var t;return e=e||{},"undefined"!=typeof e.item&&(t=e.ptrt||window.location.href,e.ptrt=window.location.protocol+"//"+window.location.hostname+"/modules/personalisation/my/favourites/signedin.html?params[ptrt]="+t+"&params[item]="+e.item),s("signin",e)},i.getSignOutUrl=function(e){return s("signout",e)},i.getRegisterUrl=function(e){return s("register",e)},i.doFullPageSignIn=function(e){var t=i.getSignInUrl(e);e.target&&"_self"!=e.target?window.open(t,e.target):window.location.href=t};var c={};return i.onSignedIn=function(){c.signedIn&&(c.signedIn(),c={})},i.events.subscribe("signedIn",i.onSignedIn),i.onSigninCancelled=function(){c.signinCancelled&&(c.signinCancelled(new i.SigninCancelledError),c={})},i.events.subscribe("signinCancelled",i.onSigninCancelled),i.signIn=function(e,t){"function"==typeof e&&(t=e,e={}),e=e||{},e.useOverlay=e.useOverlay!==!1,e.target=e.target||"_self",e.locale=o(e.locale),t=t||e.onSuccess;{var n=e.onError||t;({useOverlay:e.useOverlay,locale:e.locale,policyname:e.policyname,ptrt:e.ptrt})}if(!e.useOverlay)return i.doFullPageSignIn(e);var s=setTimeout(function(){i.doFullPageSignIn(e)},7e3);r(["idcta/idcta-1"],function(){clearTimeout(s),a("signedIn",t),a("signinCancelled",n)})},i._listenToIdEvents=function(){r(["idcta/idcta-1"],function(e){if(e&&"object"==typeof e.signals){var t=function(t){var n=e.signals[t];return n&&"function"==typeof n.add?(n.add(function(){i.events.publish(t)}),!0):!1};t("signedIn")&&t("signinShown"),i.events.subscribe("signinShown",function(){i._cancelEventSet||(r(["jquery-1.9"],function(e){e("#bbcid-mask, #bbcid-overlay-container .close-button a").click(function(){i.events.publish("signinCancelled")}),e(document).keyup(function(e){27==e.keyCode&&i.events.publish("signinCancelled")})}),i._cancelEventSet=!0)})}})},i.SigninCancelledError=function(){this.name="ps_SigninCancelled",this.eventDescriptor="signInCancelled",this.message="User must sign in for this functionality"},i.SigninCancelledError.prototype=new Error,i._listenToIdEvents(),i}),define("personalisation/favourite/model/snes",["./map","./snes-service","../event","../../util","../error","./anonymous","../../web-storage/cache","../../user","exports"],function(e,t,n,r,i,o,s,a,c){return c={cache:s.getInstance("ps_my_f"),events:n,_setService:function(e){t=e},get:function(e,t){return n.publish("snes.get.called"),t=a.getUserId(),t?r.callWrapper(c.cache.get,!!e,function(t){return t instanceof Error?e&&e(t)||t:(map=c._parseAndSetMap(t),c.migrate(map,e))},[t,function(t,n){r.callWrapper(c._get,!!e,c._updateCache,[n],c)}],c.cache):!1},_updateCache:function(e,t){return t=t||a.getUserId(),!t||e instanceof Error||(e=c._parseAndSetMap(e)),c.cache.update(t,e),e},_parseAndSetMap:function(t,n){return!t||c._map&&c._map.equals(t)?n=c._map:c._map=n=new e(t),n},_get:function(e,r,o){return isNaN(e)?(r=r||e,e=120):e=Math.floor(((new Date).getTime()-e)/1e3),t.request("get",{async:"function"==typeof r,headers:{"Cache-control":"max-age=60, max-stale="+e},success:function(e){n.publish(["snes.retrieved","snes.get.success"],{data:e}),o=e,r&&r(e)},error:function(e,t,o){var s=new i.ServiceError(e,o);if(n.publish("snes.get.failed",{error:s}),!r)throw s;r(s)}}),o},add:function(o,s,a,u,l){return l={item:o},a="function"==typeof s,n.publish("snes.add.called",l),r.callWrapper(c.get,a,function(r){if(r){try{u=r.addAll(o,!0)}catch(p){if(p instanceof e.LimitReachedError&&n.publish("snes.add.failed.limited",{item:o,error:p}),!s)throw p;return s(p)}return u?(l.item=u,t.request("post",{data:u,async:a,success:function(){c._updateCache(),n.publish(["snes.added","snes.add.success","snes.changed"],l),s&&s(u)},error:function(e,t,o){var a=new i.ServiceError(e,o);if(r.remove(u),l.error=a,n.publish("snes.add.failed",l),!s)throw a;s(a)}})):(n.publish("snes.add.exists",{item:o}),s&&s(u)),u}})},remove:function(e,o,s,a,u){return u={item:e},s="function"==typeof o,n.publish("snes.remove.called",u),r.callWrapper(c.get,s,function(r){return(a=r.remove(e))?(u.item=a,t.request("delete",{data:a,async:s,success:function(){c._updateCache(),n.publish(["snes.removed","snes.remove.success","snes.changed"],u),o&&o(a)},error:function(e,t,s,c){if(r.add(a),c=new i.ServiceError(e,s),u.error=c,n.publish("snes.remove.failed",u),!o)throw c;o(c)}}),a):(u.error="Not found",n.publish("snes.remove.failed",u),s?void o(!1):!1)})},replace:function(e,t,i,o,s,a){return o="function"==typeof i,a={"old-item":e,item:t},n.publish("snes.replace.called",a),r.callWrapper(c.get,o,function(u){return(t=u.replace(e,t))?(s={create:[t],"delete":[e]},a.item=t,r.callWrapper(c._batch,o,function(e){if(e instanceof Error){if(a.error=e,n.publish("snes.replace.failed",a),!o)throw e}else if(a.result=e,n.publish(["snes.replaced","snes.replace.success"],a),!o)return e;i(e)},[s],c,!1),t):(a.error="Not found",n.publish("snes.replace.failed",a),o?void i(!1):!1)})},migrate:function(e,t){if(o.hasFavourites()){var i=o.migrate(e),s={actions:i};if(n.publish("snes.migrate.called",s),i.create||i["delete"])return r.callWrapper(c._batch,!!t,function(r){return r instanceof Error?(s.error=r,n.publish("snes.migrate.failed",s)):(s.processed=r,n.publish(["snes.migrated","snes.migrate.success"],s),c._updateCache(e)),t&&t(e),e},[i],c,!1)}return t&&t(e),e},_batch:function(e,r,o,s){return o={actions:e},n.publish("snes.batch.called",o),s=void 0,e&&t.request("batch",{data:e,async:"function"==typeof r,success:function(e){o.data=e,s=e,c._updateCache(),n.publish(["snes.batched","snes.batch.success","snes.changed"],o),r&&r(s)},error:function(e,t,s){var a=new i.ServiceError(e,s);if(o.error=a,n.publish("snes.batch.failed",o),!r)throw a;r(a)}}),s}}}),define("personalisation/favourite",["./settings","./favourite/event","./favourite/model/anonymous","./favourite/model/snes","./favourite/error","./model/item","./user","./web-storage/cache","./util","exports","module"],function(e,t,n,r,i,o,s,a,c,u){u=u||{},u.user=s,u.events=t,u.settings=e,u._Cache=a,s.events.subscribe("signedIn",function(){var e=n.hasFavourites();u.get(function(n){n instanceof Error||e||t.publish("snes.changed",{items:n})})}),u._useAnonymous=function(t){return e.favourite.get("allowAnonymous",t)&&!s.isSignedIn()},u._proxyPostFunction=function(e,t,n,r){var i,o=t&&(t.appId||t[0]&&t[0].appId),a=u._getModel(o);return a?i=a[e].apply(a,n):s.signIn(t,function(t){if(t instanceof Error){if(!r)throw t;r(t)}else a=u._getModel(o),i=a[e].apply(a,n)}),i},u._getModel=function(t){var i=!1;return s.isSignedIn()?i=r:(r.cache.clear(),(!t||e.favourite.get("allowAnonymous",t))&&(i=n)),i},u._setSnesService=function(e){r._setService(e)},u.get=function(e,t){var n;return"function"==typeof e&&(t=e,e=!1),n=u._getModel(e),n&&c.callWrapper(n.get,!!t,function(n){return!e||n instanceof Error||(n=n.getItemsWithAppId(e)),t&&t(n),n})},u.getItemsWithAppId=function(e,t){return u.get(e,t)},u.getFavourite=function(e,t,n){var r=u._getModel().get();return r.get(e,t,n)},u.isFavourited=function(e,t,n){var r=u._getModel().get();
return r instanceof Error?!1:r.contains(e,t,n)},u.isSignedIn=s.isSignedIn,u.isFirstTimeUser=function(){return u._useAnonymous("sos2012")&&n.isFirstTimeUser()},u.add=function(e,t){return u._proxyPostFunction("add",e,arguments,t)},u.remove=function(e,t){return u._proxyPostFunction("remove",e,arguments,t)},u.replace=function(e,t,n){return u._proxyPostFunction("replace",e,arguments,n)},u.each=function(e,t,n){u.get(function(r){r instanceof Error?e(r):r.each(e,t,n)})},u.parseItem=function(e,t){return new o(e,t)}});
//# sourceMappingURL=favourite.js.map